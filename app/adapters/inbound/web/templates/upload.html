{% extends "base.html" %}

{% block title %}Upload — Voxscribe{% endblock %}

{% block extra_styles %}
/* ── Upload Section ── */
.upload-card {
    margin-bottom: 1.5rem;
}

.drop-zone {
    border: 2px dashed var(--slate-200);
    border-radius: var(--radius-lg);
    padding: 2.5rem 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: border-color var(--transition), background var(--transition), transform var(--transition);
    margin-bottom: 1.25rem;
    position: relative;
}
.drop-zone:hover {
    border-color: var(--navy-800);
    background: var(--slate-100);
}
.drop-zone.dragover {
    border-color: var(--teal-500);
    background: rgba(79,209,197,0.06);
    transform: scale(1.01);
}
.drop-zone-icon {
    width: 44px;
    height: 44px;
    margin: 0 auto 0.75rem;
    color: var(--slate-400);
    transition: color var(--transition);
}
.drop-zone:hover .drop-zone-icon,
.drop-zone.dragover .drop-zone-icon {
    color: var(--navy-800);
}
.drop-zone-title {
    font-weight: 600;
    color: var(--navy-700);
    font-size: 1rem;
}
.drop-zone-sub {
    color: var(--slate-500);
    font-size: 0.85rem;
    margin-top: 0.25rem;
}
.drop-zone-formats {
    font-size: 0.78rem;
    color: var(--slate-400);
    margin-top: 0.5rem;
}

/* ── File List ── */
.file-list { margin-bottom: 1rem; }
.file-item {
    background: var(--slate-50);
    padding: 0.6rem 0.85rem;
    border-radius: var(--radius-sm);
    margin-bottom: 0.4rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}
.file-item .name { flex: 1; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.file-item .size { color: var(--slate-500); font-size: 0.8rem; }
.file-item .remove {
    cursor: pointer; color: var(--red-text); background: none; border: none;
    font-size: 1.1rem; line-height: 1; padding: 0.15rem 0.3rem; border-radius: 4px;
    transition: background var(--transition);
}
.file-item .remove:hover { background: var(--red-bg); }

/* ── Form Controls ── */
.form-row {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
    margin-bottom: 1.25rem;
}
.form-group { flex: 1; }
.form-group label {
    display: block;
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--slate-700);
    margin-bottom: 0.35rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}
.form-group select {
    width: 100%;
    padding: 0.55rem 0.75rem;
    border: 1.5px solid var(--slate-200);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    color: var(--navy-900);
    background: var(--white);
    transition: border-color var(--transition);
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 4.5l3 3 3-3' fill='none' stroke='%2364748b' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.7rem center;
    padding-right: 2rem;
}
.form-group select:focus {
    outline: none;
    border-color: var(--navy-800);
}

.submit-btn {
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
}

/* ── Upload Progress ── */
.upload-progress {
    display: none;
    margin-top: 1rem;
}
.upload-progress.visible { display: block; }
.progress-track {
    height: 6px;
    background: var(--slate-200);
    border-radius: 3px;
    overflow: hidden;
}
.progress-track-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--navy-800), var(--teal-500));
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 3px;
}
.progress-info {
    text-align: center;
    margin-top: 0.5rem;
    color: var(--slate-500);
    font-size: 0.85rem;
}

.job-links { margin-top: 1rem; }
.job-links a {
    display: block;
    padding: 0.5rem 0.75rem;
    background: var(--slate-100);
    border-radius: var(--radius-sm);
    margin-bottom: 0.4rem;
    text-decoration: none;
    color: var(--navy-800);
    font-weight: 500;
    font-size: 0.9rem;
    transition: background var(--transition);
}
.job-links a:hover { background: var(--slate-200); }

/* ── History Section ── */
.history-section {
    margin-top: 0.5rem;
}
.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}
.history-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--navy-700);
}

/* ── Search ── */
.search-box {
    position: relative;
    flex: 0 1 220px;
}
.search-box input {
    width: 100%;
    padding: 0.45rem 0.7rem 0.45rem 2rem;
    border: 1.5px solid var(--slate-200);
    border-radius: var(--radius-sm);
    font-size: 0.825rem;
    color: var(--navy-900);
    transition: border-color var(--transition);
}
.search-box input:focus { outline: none; border-color: var(--navy-800); }
.search-box input::placeholder { color: var(--slate-400); }
.search-icon {
    position: absolute;
    left: 0.55rem;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    color: var(--slate-400);
    pointer-events: none;
}

/* ── Filter Tabs ── */
.filter-tabs {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 0.75rem;
    background: var(--slate-100);
    border-radius: var(--radius-sm);
    padding: 0.2rem;
}
.filter-tab {
    padding: 0.35rem 0.7rem;
    border: none;
    border-radius: 4px;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--slate-500);
    background: transparent;
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
}
.filter-tab:hover { color: var(--navy-700); }
.filter-tab.active {
    background: var(--white);
    color: var(--navy-800);
    box-shadow: var(--shadow-sm);
}
.filter-tab .count {
    font-weight: 400;
    font-size: 0.72rem;
    opacity: 0.7;
    margin-left: 0.15rem;
}

/* ── Job Rows ── */
.job-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.5rem 0.75rem;
    padding: 0.75rem 0.85rem;
    background: var(--slate-50);
    border-radius: var(--radius-md);
    margin-bottom: 0.4rem;
    text-decoration: none;
    color: inherit;
    transition: background var(--transition), box-shadow var(--transition);
    align-items: center;
}
.job-row:hover { background: var(--slate-200); box-shadow: var(--shadow-sm); }

.job-row-main {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    min-width: 0;
}
.job-filename {
    font-weight: 600;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--navy-700);
}
.job-row-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    grid-column: 1 / -1;
    font-size: 0.78rem;
    color: var(--slate-500);
}
.meta-sep { opacity: 0.4; }
.meta-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
}

/* ── Empty State ── */
.empty-state {
    text-align: center;
    color: var(--slate-400);
    padding: 2.5rem 1rem;
    font-size: 0.9rem;
}
.empty-state-icon {
    width: 40px;
    height: 40px;
    color: var(--slate-200);
    margin: 0 auto 0.75rem;
}
.empty-state a {
    color: var(--navy-800);
    text-decoration: none;
    font-weight: 600;
}
.empty-state a:hover { text-decoration: underline; }

/* ── Cleanup Button ── */
.btn-cleanup {
    padding: 0.35rem 0.7rem;
    font-size: 0.8rem;
    background: var(--red-bg);
    color: var(--red-text);
    border: 1.5px solid transparent;
    border-radius: var(--radius-sm);
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    transition: background var(--transition), border-color var(--transition);
    white-space: nowrap;
}
.btn-cleanup:hover {
    background: #fecaca;
    border-color: var(--red-text);
}
.btn-cleanup:active {
    transform: scale(0.97);
}
.btn-cleanup:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ── Responsive ── */
@media (max-width: 600px) {
    .form-row { flex-direction: column; }
    .search-box { flex: 1 1 100%; }
    .history-header { flex-direction: column; align-items: flex-start; }
    .filter-tabs { flex-wrap: wrap; }
    .job-row-meta { font-size: 0.72rem; }
}
{% endblock %}

{% block content %}
<div class="card upload-card">
    <form id="upload-form" enctype="multipart/form-data">
        <div class="drop-zone" id="drop-zone">
            <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <p class="drop-zone-title">Drop audio files here</p>
            <p class="drop-zone-sub">or click to browse your files</p>
            <p class="drop-zone-formats">MP3, WAV, FLAC, OGG &middot; Max 500 MB each</p>
            <input type="file" id="file-input" name="file" accept=".mp3,.wav,.flac,.ogg" multiple hidden>
        </div>

        <div class="file-list" id="file-list"></div>

        <div class="form-row">
            <div class="form-group">
                <label for="language">Language</label>
                <select name="language" id="language">
                    <option value="pt-BR" selected>Portuguese (Brazil)</option>
                    <option value="en-US">English (US)</option>
                    <option value="es-ES">Spanish (Spain)</option>
                </select>
            </div>
        </div>

        <button type="submit" class="btn btn-primary submit-btn" id="submit-btn" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/></svg>
            Upload &amp; Transcribe
        </button>

        <div class="upload-progress" id="upload-progress">
            <div class="progress-track"><div class="progress-track-fill" id="progress-fill"></div></div>
            <p class="progress-info" id="progress-text">Uploading...</p>
        </div>

        <div class="job-links" id="job-links" style="display:none"></div>
    </form>

    <div id="error-container"></div>
</div>

<div class="card history-section" id="history-section">
    <div class="history-header">
        <span class="history-title">Transcription History</span>
        <div style="display:flex;align-items:center;gap:0.5rem;">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" id="search-input" placeholder="Search by filename...">
            </div>
            <button type="button" class="btn btn-cleanup" id="cleanup-btn" title="Delete all transcriptions" style="display:none;">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                Clear All
            </button>
        </div>
    </div>
    <div class="filter-tabs" id="filter-tabs">
        <button class="filter-tab active" data-filter="all">All <span class="count" id="count-all"></span></button>
        <button class="filter-tab" data-filter="COMPLETED">Completed <span class="count" id="count-completed"></span></button>
        <button class="filter-tab" data-filter="active">In Progress <span class="count" id="count-active"></span></button>
        <button class="filter-tab" data-filter="FAILED">Failed <span class="count" id="count-failed"></span></button>
    </div>
    <div id="jobs-list">
        <div class="empty-state">Loading...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    var dropZone = document.getElementById('drop-zone');
    var fileInput = document.getElementById('file-input');
    var fileList = document.getElementById('file-list');
    var submitBtn = document.getElementById('submit-btn');
    var form = document.getElementById('upload-form');
    var uploadProgress = document.getElementById('upload-progress');
    var progressFill = document.getElementById('progress-fill');
    var progressText = document.getElementById('progress-text');
    var errorContainer = document.getElementById('error-container');
    var jobLinks = document.getElementById('job-links');
    var searchInput = document.getElementById('search-input');
    var MAX_SIZE = 500 * 1024 * 1024;
    var ALLOWED = ['.mp3', '.wav', '.flac', '.ogg'];
    var selectedFiles = [];
    var allJobs = [];
    var currentFilter = 'all';
    var cleanupBtn = document.getElementById('cleanup-btn');

    function formatSize(bytes) {
        if (bytes == null || bytes === 0) return '—';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function formatDuration(seconds) {
        if (seconds == null) return '—';
        var m = Math.floor(seconds / 60);
        var s = Math.floor(seconds % 60);
        return m + ':' + (s < 10 ? '0' : '') + s;
    }

    function timeAgo(dateStr) {
        var now = new Date();
        var then = new Date(dateStr);
        var diff = Math.floor((now - then) / 1000);
        if (diff < 60) return 'just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
        return then.toLocaleDateString();
    }

    function showError(msg) {
        errorContainer.textContent = '';
        var div = document.createElement('div');
        div.className = 'error-msg';
        div.textContent = msg;
        errorContainer.appendChild(div);
    }

    function clearError() { errorContainer.textContent = ''; }

    function renderFileList() {
        fileList.textContent = '';
        selectedFiles.forEach(function(file, idx) {
            var item = document.createElement('div');
            item.className = 'file-item';

            var nameSpan = document.createElement('span');
            nameSpan.className = 'name';
            nameSpan.textContent = file.name;

            var sizeSpan = document.createElement('span');
            sizeSpan.className = 'size';
            sizeSpan.textContent = formatSize(file.size);

            var removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove';
            removeBtn.textContent = '\u00D7';
            removeBtn.setAttribute('data-index', idx);
            removeBtn.addEventListener('click', function() {
                selectedFiles.splice(parseInt(this.getAttribute('data-index')), 1);
                renderFileList();
            });

            item.appendChild(nameSpan);
            item.appendChild(sizeSpan);
            item.appendChild(removeBtn);
            fileList.appendChild(item);
        });
        submitBtn.disabled = selectedFiles.length === 0;
    }

    function addFiles(files) {
        clearError();
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!ALLOWED.includes(ext)) {
                showError('Unsupported format: ' + file.name + '. Accepted: MP3, WAV, FLAC, OGG');
                continue;
            }
            if (file.size > MAX_SIZE) {
                showError(file.name + ' exceeds 500 MB limit');
                continue;
            }
            selectedFiles.push(file);
        }
        renderFileList();
    }

    dropZone.addEventListener('click', function() { fileInput.click(); });
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length) addFiles(fileInput.files);
        fileInput.value = '';
    });

    ['dragenter', 'dragover'].forEach(function(e) {
        dropZone.addEventListener(e, function(ev) { ev.preventDefault(); dropZone.classList.add('dragover'); });
    });
    ['dragleave', 'drop'].forEach(function(e) {
        dropZone.addEventListener(e, function(ev) { ev.preventDefault(); dropZone.classList.remove('dragover'); });
    });
    dropZone.addEventListener('drop', function(ev) {
        if (ev.dataTransfer.files.length) addFiles(ev.dataTransfer.files);
    });

    form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        clearError();
        if (selectedFiles.length === 0) return;

        var language = document.getElementById('language').value;
        submitBtn.disabled = true;
        uploadProgress.classList.add('visible');

        var completed = 0;
        var total = selectedFiles.length;
        var redirectUrls = [];

        function uploadNext(index) {
            if (index >= total) {
                progressText.textContent = 'All files uploaded!';
                if (redirectUrls.length === 1) {
                    window.location.href = redirectUrls[0];
                } else {
                    jobLinks.style.display = 'block';
                    jobLinks.textContent = '';
                    var heading = document.createElement('p');
                    heading.style.fontWeight = '500';
                    heading.style.marginBottom = '0.5rem';
                    heading.textContent = 'Jobs created (' + redirectUrls.length + '):';
                    jobLinks.appendChild(heading);
                    redirectUrls.forEach(function(url, i) {
                        var a = document.createElement('a');
                        a.href = url;
                        a.textContent = 'Job ' + (i + 1) + ' — ' + selectedFiles[i].name;
                        jobLinks.appendChild(a);
                    });
                }
                return;
            }

            var data = new FormData();
            data.append('file', selectedFiles[index]);
            data.append('language', language);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/upload');

            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    var filePct = (e.loaded / e.total);
                    var overallPct = Math.round(((completed + filePct) / total) * 100);
                    progressFill.style.width = overallPct + '%';
                    progressText.textContent = 'Uploading file ' + (index + 1) + '/' + total + '... ' + overallPct + '%';
                }
            });

            xhr.onload = function() {
                if (xhr.status === 201) {
                    var resp = JSON.parse(xhr.responseText);
                    redirectUrls.push(resp.redirect_url);
                    completed++;
                    uploadNext(index + 1);
                } else {
                    var msg = 'Upload failed for ' + selectedFiles[index].name;
                    try { msg = JSON.parse(xhr.responseText).detail || msg; } catch(e) {}
                    showError(msg);
                    submitBtn.disabled = false;
                    uploadProgress.classList.remove('visible');
                }
            };

            xhr.onerror = function() {
                showError('Network error uploading ' + selectedFiles[index].name);
                submitBtn.disabled = false;
                uploadProgress.classList.remove('visible');
            };

            xhr.send(data);
        }

        uploadNext(0);
    });

    /* ── History: Filter & Search ── */

    function isActiveStatus(status) {
        return status === 'PENDING' || status === 'CONVERTING' || status === 'TRANSCRIBING';
    }

    function updateCounts() {
        var all = allJobs.length;
        var completed = 0, active = 0, failed = 0;
        allJobs.forEach(function(j) {
            if (j.status === 'COMPLETED') completed++;
            else if (j.status === 'FAILED') failed++;
            else if (isActiveStatus(j.status)) active++;
        });
        document.getElementById('count-all').textContent = '(' + all + ')';
        document.getElementById('count-completed').textContent = '(' + completed + ')';
        document.getElementById('count-active').textContent = '(' + active + ')';
        document.getElementById('count-failed').textContent = '(' + failed + ')';
    }

    function filterJobs() {
        var query = searchInput.value.toLowerCase().trim();
        var container = document.getElementById('jobs-list');
        container.textContent = '';

        var filtered = allJobs.filter(function(job) {
            var statusMatch = (currentFilter === 'all') ||
                (currentFilter === 'active' && isActiveStatus(job.status)) ||
                (job.status === currentFilter);
            var searchMatch = !query || job.original_filename.toLowerCase().indexOf(query) !== -1;
            return statusMatch && searchMatch;
        });

        if (allJobs.length === 0) {
            container.innerHTML =
                '<div class="empty-state">' +
                '<svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>' +
                '<p>No transcriptions yet</p>' +
                '<p style="margin-top:0.35rem"><a href="#" onclick="document.getElementById(\'drop-zone\').click();return false;">Upload your first audio file</a> to get started</p>' +
                '</div>';
            return;
        }

        if (filtered.length === 0) {
            container.innerHTML =
                '<div class="empty-state">' +
                '<p>No matching transcriptions</p>' +
                '<p style="margin-top:0.25rem;font-size:0.82rem;">Try a different filter or search term</p>' +
                '</div>';
            return;
        }

        filtered.forEach(function(job) {
            var a = document.createElement('a');
            a.href = '/jobs/' + job.job_id;
            a.className = 'job-row';
            a.setAttribute('data-status', job.status);

            var main = document.createElement('div');
            main.className = 'job-row-main';

            var nameSpan = document.createElement('span');
            nameSpan.className = 'job-filename';
            nameSpan.textContent = job.original_filename;

            var badge = document.createElement('span');
            var status = job.status.toLowerCase();
            badge.className = 'badge badge-' + status;
            badge.textContent = job.status;

            main.appendChild(nameSpan);
            a.appendChild(main);
            a.appendChild(badge);

            var meta = document.createElement('div');
            meta.className = 'job-row-meta';

            var parts = [];
            if (job.language) parts.push(job.language);
            if (job.engine_name) parts.push(job.engine_name);
            if (job.size_bytes) parts.push(formatSize(job.size_bytes));
            if (job.duration_seconds != null) parts.push(formatDuration(job.duration_seconds));
            parts.push(timeAgo(job.created_at));

            parts.forEach(function(text, i) {
                var span = document.createElement('span');
                span.className = 'meta-tag';
                span.textContent = text;
                meta.appendChild(span);
                if (i < parts.length - 1) {
                    var sep = document.createElement('span');
                    sep.className = 'meta-sep';
                    sep.textContent = '\u00B7';
                    meta.appendChild(sep);
                }
            });

            a.appendChild(meta);
            container.appendChild(a);
        });
    }

    // Filter tab clicks
    document.getElementById('filter-tabs').addEventListener('click', function(e) {
        var tab = e.target.closest('.filter-tab');
        if (!tab) return;
        document.querySelectorAll('.filter-tab').forEach(function(t) { t.classList.remove('active'); });
        tab.classList.add('active');
        currentFilter = tab.getAttribute('data-filter');
        filterJobs();
    });

    // Search input
    searchInput.addEventListener('input', function() { filterJobs(); });

    // Cleanup button
    cleanupBtn.addEventListener('click', function() {
        if (!confirm('Delete ALL transcriptions? This cannot be undone.')) return;
        cleanupBtn.disabled = true;
        cleanupBtn.textContent = 'Deleting...';
        fetch('/api/jobs', { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                allJobs = [];
                updateCounts();
                filterJobs();
                cleanupBtn.style.display = 'none';
                cleanupBtn.disabled = false;
                cleanupBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg> Clear All';
            })
            .catch(function() {
                alert('Failed to delete transcriptions. Please try again.');
                cleanupBtn.disabled = false;
                cleanupBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg> Clear All';
            });
    });

    // Load jobs
    function loadJobs() {
        fetch('/api/jobs')
            .then(function(r) { return r.json(); })
            .then(function(jobs) {
                allJobs = jobs;
                updateCounts();
                filterJobs();
                cleanupBtn.style.display = allJobs.length > 0 ? '' : 'none';
            })
            .catch(function() {
                document.getElementById('jobs-list').innerHTML = '<div class="empty-state">Could not load transcription history.</div>';
            });
    }
    loadJobs();
})();
</script>
{% endblock %}
